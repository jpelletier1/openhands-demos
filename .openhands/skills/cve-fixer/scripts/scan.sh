#!/bin/bash
# Automated CVE scan workflow script
# Usage: ./scan_and_fix.sh <directory> [--severity LEVELS]

# Note: This script performs scanning only. For remediation, the agent must
# manually update dependencies and fix code patterns. Do NOT use trivy --fix.

set -e

# Default values
SCAN_DIR="${1:-.}"
SEVERITY="CRITICAL,HIGH"
OUTPUT_FILE="trivy-scan-results.json"

# Parse arguments
shift || true
while [[ $# -gt 0 ]]; do
    case $1 in
        --severity)
            SEVERITY="$2"
            shift 2
            ;;
        --output)
            OUTPUT_FILE="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

echo "=== CVE Scan and Fix Workflow ==="
echo "Scanning directory: $SCAN_DIR"
echo "Severity filter: $SEVERITY"
echo ""

# Check if Trivy is installed
if ! command -v trivy &> /dev/null; then
    echo "Installing Trivy..."
    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.56.0
fi

# Update Trivy database
echo "Updating Trivy database..."
trivy db --update

# Run scan
echo "Running Trivy scan..."
trivy fs \
    --security-checks vuln,config \
    --severity "$SEVERITY" \
    --format json \
    --output "$OUTPUT_FILE" \
    "$SCAN_DIR"

# Count vulnerabilities
CRITICAL=$(grep -o '"Severity":"CRITICAL"' "$OUTPUT_FILE" | wc -l || echo "0")
HIGH=$(grep -o '"Severity":"HIGH"' "$OUTPUT_FILE" | wc -l || echo "0")
MEDIUM=$(grep -o '"Severity":"MEDIUM"' "$OUTPUT_FILE" | wc -l || echo "0")

echo ""
echo "=== Scan Results ==="
echo "Critical: $CRITICAL"
echo "High: $HIGH"
echo "Medium: $MEDIUM"
echo "Results saved to: $OUTPUT_FILE"
echo ""

# Show summary
echo "=== Top Vulnerabilities ==="
trivy fs --severity "$SEVERITY" "$SCAN_DIR" || true

echo ""
echo "=== Scan Complete ==="
echo "For remediation: manually update dependencies and fix code patterns"
