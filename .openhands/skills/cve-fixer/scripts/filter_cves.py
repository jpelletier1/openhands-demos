#!/usr/bin/env python3
"""
CVE Filter Script
Filter and prioritize CVEs by severity from Trivy JSON output.

Usage:
    python filter_cves.py <trivy-results.json> [--severity CRITICAL,HIGH,MEDIUM]
    python filter_cves.py <trivy-results.json> --min-severity HIGH
    python filter_cves.py <trivy-results.json> --output filtered-cves.json
"""

import argparse
import json
import sys
from pathlib import Path
from typing import List, Dict, Any

SEVERITY_ORDER = {
    "CRITICAL": 4,
    "HIGH": 3,
    "MEDIUM": 2,
    "LOW": 1,
    "UNKNOWN": 0,
}


def load_trivy_results(file_path: str) -> Dict[str, Any]:
    """Load Trivy JSON results from file."""
    with open(file_path, "r") as f:
        return json.load(f)


def extract_vulnerabilities(results: Dict[str, Any]) -> List[Dict[str, Any]]:
    """Extract vulnerabilities from Trivy results."""
    vulnerabilities = []
    
    # Handle different Trivy output formats
    if "Results" in results:
        for result in results["Results"]:
            if "Vulnerabilities" in result:
                for vuln in result["Vulnerabilities"]:
                    vuln["File"] = result.get("Target", "unknown")
                    vulnerabilities.append(vuln)
    
    return vulnerabilities


def filter_by_severity(
    vulnerabilities: List[Dict[str, Any]], 
    severities: List[str]
) -> List[Dict[str, Any]]:
    """Filter vulnerabilities by severity levels."""
    severity_set = {s.upper() for s in severities}
    return [
        v for v in vulnerabilities 
        if v.get("Severity", "UNKNOWN").upper() in severity_set
    ]


def filter_by_min_severity(
    vulnerabilities: List[Dict[str, Any]], 
    min_severity: str
) -> List[Dict[str, Any]]:
    """Filter vulnerabilities by minimum severity level."""
    min_level = SEVERITY_ORDER.get(min_severity.upper(), 0)
    return [
        v for v in vulnerabilities 
        if SEVERITY_ORDER.get(v.get("Severity", "UNKNOWN").upper(), 0) >= min_level
    ]


def sort_vulnerabilities(vulnerabilities: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """Sort vulnerabilities by severity (highest first)."""
    return sorted(
        vulnerabilities,
        key=lambda v: SEVERITY_ORDER.get(v.get("Severity", "UNKNOWN").upper(), 0),
        reverse=True
    )


def print_summary(vulnerabilities: List[Dict[str, Any]]) -> None:
    """Print summary of vulnerabilities by severity."""
    counts = {"CRITICAL": 0, "HIGH": 0, "MEDIUM": 0, "LOW": 0, "UNKNOWN": 0}
    
    for v in vulnerabilities:
        severity = v.get("Severity", "UNKNOWN").upper()
        counts[severity] = counts.get(severity, 0) + 1
    
    print("\n=== CVE Summary ===")
    print(f"Critical: {counts.get('CRITICAL', 0)}")
    print(f"High:     {counts.get('HIGH', 0)}")
    print(f"Medium:   {counts.get('MEDIUM', 0)}")
    print(f"Low:      {counts.get('LOW', 0)}")
    print(f"Unknown:  {counts.get('UNKNOWN', 0)}")
    print(f"Total:    {len(vulnerabilities)}")


def print_vulnerabilities(vulnerabilities: List[Dict[str, Any]], limit: int = 20) -> None:
    """Print top vulnerabilities."""
    print(f"\n=== Top {limit} Vulnerabilities ===")
    
    for i, v in enumerate(vulnerabilities[:limit], 1):
        severity = v.get("Severity", "UNKNOWN").upper()
        vuln_id = v.get("VulnerabilityID", "N/A")
        pkg = v.get("PkgName", v.get("Package", "unknown"))
        fixed = v.get("FixedVersion", "N/A")
        file = v.get("File", "unknown")
        
        print(f"{i}. [{severity}] {vuln_id}")
        print(f"   Package: {pkg}")
        print(f"   Fixed in: {fixed}")
        print(f"   File: {file}")
        print()


def main():
    parser = argparse.ArgumentParser(
        description="Filter and prioritize CVEs from Trivy JSON output"
    )
    parser.add_argument(
        "input_file",
        help="Path to Trivy JSON results file"
    )
    parser.add_argument(
        "--severity",
        help="Comma-separated severity levels to include (CRITICAL,HIGH,MEDIUM)"
    )
    parser.add_argument(
        "--min-severity",
        help="Minimum severity level (CRITICAL, HIGH, MEDIUM, LOW)"
    )
    parser.add_argument(
        "--output", "-o",
        help="Output file for filtered results (JSON)"
    )
    parser.add_argument(
        "--limit",
        type=int,
        default=20,
        help="Number of vulnerabilities to display (default: 20)"
    )
    parser.add_argument(
        "--quiet", "-q",
        action="store_true",
        help="Suppress summary output"
    )
    
    args = parser.parse_args()
    
    # Load results
    if not Path(args.input_file).exists():
        print(f"Error: File not found: {args.input_file}", file=sys.stderr)
        sys.exit(1)
    
    results = load_trivy_results(args.input_file)
    vulnerabilities = extract_vulnerabilities(results)
    
    if not vulnerabilities:
        print("No vulnerabilities found in results.")
        sys.exit(0)
    
    # Apply filters
    if args.severity:
        severities = [s.strip() for s in args.severity.split(",")]
        vulnerabilities = filter_by_severity(vulnerabilities, severities)
    elif args.min_severity:
        vulnerabilities = filter_by_min_severity(vulnerabilities, args.min_severity)
    
    # Sort by severity
    vulnerabilities = sort_vulnerabilities(vulnerabilities)
    
    # Output
    if args.output:
        output_data = {
            "filtered_count": len(vulnerabilities),
            "total_count": len(extract_vulnerabilities(results)),
            "vulnerabilities": vulnerabilities
        }
        with open(args.output, "w") as f:
            json.dump(output_data, f, indent=2)
        print(f"Filtered results saved to: {args.output}")
    
    if not args.quiet:
        print_summary(vulnerabilities)
        print_vulnerabilities(vulnerabilities, args.limit)
    
    # Exit code based on critical/high vulnerabilities
    critical_high = sum(
        1 for v in vulnerabilities 
        if v.get("Severity", "").upper() in ("CRITICAL", "HIGH")
    )
    
    if critical_high > 0:
        print(f"\nFound {critical_high} Critical/High vulnerabilities!")
        sys.exit(1)
    else:
        print("\nNo Critical/High vulnerabilities found.")
        sys.exit(0)


if __name__ == "__main__":
    main()
